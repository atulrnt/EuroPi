from europi import *
from time import ticks_diff, ticks_ms
from random import randint, choice
from europi_script import EuroPiScript
from experimental.knobs import LockableKnob
import framebuf


# Extend EuroPiScript to allow for each output to manage its own state, the main class is Karma
class KarmaOutput(EuroPiScript):
    """
    A class that performs the output logic, each output being independent
    """

    BEGIN_AT_START = 0
    BEGIN_AT_END = 1

    def __init__(self, cv: Output):
        super().__init__()

        # Config variables
        self._cv = cv
        self._id = cvs.index(cv)
        self._global_state = self.load_state_json()
        self._state = self._global_state.get(f'{self._id}', {
            'beginning': 0,
            'delay': 0,
            'duration': 100,
            'divisions': 1,
            'repetitions': 0,
            'probability': 100,
            'division_probability': 100,
        })

        # When to begin the output
        # 0 = output starts when trigger starts
        # 1 = output starts when trigger stops
        # Whatever is chosen, the output is reset if a new trigger starts while the output is still being performed
        self._beginning = self._state['beginning']

        # How long should we wait before starting the output (in ms)
        self._delay = self._state['delay']

        # How long should the output go for (in ms)
        self._duration = self._state['duration']

        # How many sub-output should the output be divided into
        # Useful to output bursts of triggers, sounds great on MI Rings for instance
        self._divisions = self._state['divisions']

        # How many times should the output be repeated
        self._repetitions = self._state['repetitions']

        # The percentage of probability for an output to happen
        self._probability = self._state['probability']

        # The percentage of probability for an output division to happen
        self._division_probability = self._state['division_probability']

        # Runtime variables
        self.output = LOW
        self._previous_output = LOW
        self._trigger_started_at = None
        self._output_started_at = None
        self._output_ended_at = None
        self._division_started_at = None
        self._occurrences = 0
        self._division_occurrences = 0

    # Override parent method to allow each output to manage its own state inside a single file
    @property
    def _state_filename(self) -> str:
        return 'saved_state_Karma.txt'

    @property
    def beginning(self) -> int:
        return self._beginning

    @beginning.setter
    def beginning(self, value):
        if value not in [self.BEGIN_AT_START, self.BEGIN_AT_END]:
            raise ValueError(
                f"Beginning can only be set to {self.BEGIN_AT_START} or {self.BEGIN_AT_END}, {value} received")

        self._beginning = value
        self._save_setting('beginning', value)

    @property
    def delay(self) -> int:
        return self._delay

    @delay.setter
    def delay(self, value):
        if not isinstance(value, int) or not 0 <= value <= 10000:
            raise ValueError(f"Delay can only be set to an integer between 0 and 10000, {value} received")

        self._delay = value
        self._save_setting('delay', value)

    @property
    def duration(self) -> int:
        return self._duration

    @duration.setter
    def duration(self, value):
        if not isinstance(value, int) or not 10 <= value <= 10000:
            raise ValueError(f"Duration can only be set to an integer between 10 and 10000, {value} received")

        self._duration = value
        self._save_setting('duration', value)

    @property
    def divisions(self) -> int:
        return self._divisions

    @divisions.setter
    def divisions(self, value):
        if not isinstance(value, int) or not 1 <= value <= 100:
            raise ValueError(f"Divisions can only be set to an integer between 1 and 100, {value} received")

        self._divisions = value
        self._save_setting('divisions', value)

    @property
    def repetitions(self) -> int:
        return self._repetitions

    @repetitions.setter
    def repetitions(self, value):
        if not isinstance(value, int) or not 0 <= value <= 100:
            raise ValueError(f"Repetitions can only be set to an integer between 0 and 100, {value} received")

        self._repetitions = value
        self._save_setting('repetitions', value)

    @property
    def probability(self) -> int:
        return self._probability

    @probability.setter
    def probability(self, value):
        if not isinstance(value, int) or not 1 <= value <= 100:
            raise ValueError(f"Probability can only be set to an integer between 1 and 100, {value} received")

        self._probability = value
        self._save_setting('probability', value)

    @property
    def division_probability(self) -> int:
        return self._division_probability

    @division_probability.setter
    def division_probability(self, value):
        if not isinstance(value, int) or not 1 <= value <= 100:
            raise ValueError(
                f"Probability per division can only be set to an integer between 1 and 100, {value} received")

        self._division_probability = value
        self._save_setting('division_probability', value)

    def _save_setting(self, key, value):
        self._state[key] = value
        self._global_state[self._id] = self._state
        self.save_state_json(self._global_state)

    @classmethod
    def _can_output(cls, probability: int) -> bool:
        return randint(1, 100) <= probability

    def _get_division_duration(self) -> float:
        if self._divisions == 1:
            return self._duration

        return self._duration / (self._divisions * 2)

    def _start(self):
        if not self._can_output(self._probability):
            return

        self._trigger_started_at = time.ticks_ms()

    def _reset(self):
        self.output = LOW
        self._trigger_started_at = None
        self._output_started_at = None
        self._division_started_at = None
        self._division_occurrences = 0

    def start(self):
        self._reset()

        if self._beginning == self.BEGIN_AT_START:
            self._start()

    def end(self):
        if self._beginning == self.BEGIN_AT_END:
            self._start()

    def main(self):
        if not self._trigger_started_at:
            self.output = LOW
        else:
            # Start the output
            if not self._output_started_at and time.ticks_diff(time.ticks_ms(), self._trigger_started_at) >= self._delay:
                self._output_started_at = time.ticks_ms()

            # End the karma run
            elif self._output_started_at and time.ticks_diff(time.ticks_ms(), self._output_started_at) >= self._duration:
                if self._repetitions > 0 and self._occurrences < self._repetitions:
                    if not self._output_ended_at:
                        self._output_ended_at = time.ticks_ms()
                    elif time.ticks_diff(time.ticks_ms(), self._output_ended_at) >= self._duration:
                        self._occurrences += 1
                        self._reset()
                        self._start()
                else:
                    self._occurrences = 0
                    self._output_ended_at = None
                    self._reset()

            # Handle the current division
            if self._output_started_at:
                if not self._division_started_at and self._division_occurrences < self._divisions:
                    self._division_started_at = time.ticks_ms()

                    if self._can_output(self._division_probability):
                        self.output = HIGH
                else:
                    division_running_time = time.ticks_diff(time.ticks_ms(), self._division_started_at)
                    division_duration = self._get_division_duration()
                    full_division_duration = division_duration * 2

                    if division_duration <= division_running_time < full_division_duration:
                        self.output = LOW
                    elif division_running_time >= full_division_duration:
                        self._division_occurrences += 1
                        self._division_started_at = None
            else:
                self.output = LOW

        if self.output != self._previous_output:
            self._previous_output = self.output
            self._cv.value(self.output)


class KarmaDisplay:
    """
    A class to handle the display for the Karma script
    """

    """
    Sets the delay between each check of k2 to define on which setting the user is
    Decreasing it will make the menu more responsive at the expense of performances
    """
    SETTING_SELECTION_CHECK_DELAY = 100

    """
    Sets the delay in ms before which the menu is closed.
    The menu is constantly checking for Knobs positions which is impacting the script performances,
    by closing the menu after some time allows for the script to goes back to a faster run time.
    Pixels can also burn if they stay active for an extended period of time.
    """
    MENU_DELAY = 10000

    DIRECTION_LEFT = 0
    DIRECTION_RIGHT = 1
    DIRECTION_TOP = 2
    DIRECTION_BOTTOM = 3

    SCREENSAVERS = [
        [
            0x00, 0x04, 0x3b, 0x81, 0x40, 0x23, 0x80, 0x22, 0x22, 0x03, 0x82, 0x01, 0xa0, 0x8e, 0x18, 0x00,
            0x00, 0x04, 0x6e, 0x81, 0x20, 0x20, 0xf0, 0x23, 0x62, 0x0e, 0x81, 0x01, 0x20, 0x03, 0xb0, 0x00,
            0x00, 0x07, 0xb8, 0x81, 0x20, 0x40, 0x98, 0x21, 0x42, 0x19, 0x01, 0x82, 0x20, 0x40, 0xf0, 0x00,
            0x00, 0x07, 0xe0, 0x01, 0x10, 0xc0, 0x46, 0x21, 0xc2, 0x61, 0x00, 0x86, 0x20, 0x40, 0x70, 0x00,
            0x00, 0x0f, 0x81, 0x01, 0x00, 0x80, 0x41, 0xa0, 0x82, 0xc3, 0x00, 0x44, 0x20, 0x40, 0x7c, 0x00,
            0x00, 0x3b, 0x01, 0x01, 0x09, 0x00, 0x20, 0xe0, 0x83, 0x02, 0x00, 0x48, 0x20, 0x20, 0xce, 0x00,
            0x00, 0xc9, 0x81, 0x01, 0x07, 0x00, 0x10, 0x31, 0xc6, 0x04, 0x00, 0x38, 0x20, 0x20, 0xc3, 0xc0,
            0x03, 0x18, 0xc2, 0x01, 0x02, 0x00, 0x18, 0x19, 0x4c, 0x0c, 0x00, 0x30, 0x20, 0x21, 0x81, 0xe0,
            0x0c, 0x30, 0xc2, 0x01, 0x07, 0x00, 0x08, 0x1d, 0x48, 0x08, 0x00, 0x70, 0x20, 0x23, 0x00, 0x98,
            0x98, 0x60, 0x62, 0x01, 0x04, 0xc0, 0x04, 0x17, 0x74, 0x1f, 0xff, 0xc8, 0x20, 0x17, 0x00, 0x46,
            0xe0, 0xc0, 0x32, 0x01, 0x08, 0x7f, 0xff, 0x13, 0x24, 0xfc, 0x03, 0xf8, 0x20, 0x16, 0x00, 0x21,
            0x80, 0x80, 0x12, 0x01, 0x0b, 0xf0, 0x03, 0xf3, 0x67, 0xe0, 0x06, 0x0e, 0x20, 0x18, 0x00, 0x10,
            0x01, 0x00, 0x0e, 0x01, 0x1c, 0x0c, 0x01, 0x9e, 0xfc, 0xc0, 0x0c, 0x07, 0xa0, 0x14, 0x00, 0x18,
            0x02, 0x00, 0x0e, 0x01, 0x70, 0x06, 0x00, 0xcf, 0xf9, 0x80, 0x30, 0x02, 0x60, 0x78, 0x00, 0x09,
            0x44, 0x00, 0x06, 0x01, 0xa0, 0x01, 0x80, 0x6f, 0xff, 0x00, 0x60, 0x02, 0x38, 0x58, 0x00, 0x07,
            0x44, 0x00, 0x07, 0x07, 0x20, 0x00, 0xe0, 0xff, 0x3f, 0xe1, 0xc0, 0x01, 0x26, 0x90, 0x00, 0x06,
            0x28, 0x00, 0x06, 0xd9, 0x40, 0x00, 0x1e, 0x0e, 0x3c, 0x1f, 0x00, 0x01, 0xa7, 0xb0, 0x00, 0x06,
            0x30, 0x00, 0x06, 0x71, 0x20, 0x00, 0x73, 0xf7, 0x3f, 0xe1, 0xc0, 0x01, 0x2c, 0xd0, 0x00, 0x05,
            0x10, 0x00, 0x06, 0x59, 0x20, 0x01, 0xc0, 0x3f, 0xff, 0x00, 0x60, 0x03, 0x30, 0x78, 0x00, 0x09,
            0x38, 0x00, 0x0e, 0x8f, 0x10, 0x03, 0x00, 0x4f, 0xf8, 0x80, 0x18, 0x02, 0xe0, 0x38, 0x00, 0x00,
            0x28, 0x00, 0x0b, 0x03, 0x90, 0x06, 0x00, 0x8e, 0xfc, 0x40, 0x0c, 0x07, 0x20, 0x1c, 0x00, 0x10,
            0x84, 0x00, 0x12, 0x01, 0xf8, 0x18, 0x01, 0x39, 0xe7, 0xa0, 0x03, 0x1c, 0x20, 0x1c, 0x00, 0x20,
            0x46, 0x00, 0x16, 0x01, 0x1e, 0x30, 0x03, 0xf1, 0x20, 0xfc, 0x07, 0xe8, 0x20, 0x16, 0x00, 0x41,
            0x72, 0x00, 0x2e, 0x01, 0x0f, 0xff, 0xfe, 0x13, 0x32, 0x0f, 0xfc, 0xc8, 0x20, 0x13, 0x00, 0x86,
            0x4d, 0x00, 0x7a, 0x01, 0x04, 0x87, 0x04, 0x17, 0x3a, 0x0c, 0x00, 0x38, 0x20, 0x31, 0x01, 0x8c,
            0x03, 0x80, 0x52, 0x01, 0x03, 0x00, 0x08, 0x1d, 0x2e, 0x06, 0x00, 0x10, 0x20, 0x21, 0x83, 0x30,
            0x81, 0xc0, 0xe1, 0x01, 0x03, 0x00, 0x18, 0x18, 0xc2, 0x02, 0x00, 0x38, 0x20, 0x20, 0x86, 0xc0,
            0x80, 0x31, 0xc1, 0x01, 0x05, 0x00, 0x30, 0x20, 0xc1, 0x01, 0x00, 0x64, 0x20, 0x20, 0x4f, 0x00,
            0x80, 0x09, 0xc1, 0x01, 0x08, 0x80, 0x20, 0x60, 0xc1, 0xc1, 0x80, 0x46, 0x20, 0x40, 0x3c, 0x00,
            0x80, 0x06, 0x81, 0x01, 0x08, 0x80, 0x41, 0xa0, 0xc1, 0x60, 0x80, 0x82, 0x20, 0x40, 0x70, 0x00,
            0x80, 0x03, 0x80, 0x01, 0x10, 0x40, 0x43, 0x20, 0xc1, 0x18, 0x40, 0x81, 0x20, 0x41, 0xf0, 0x00,
            0x80, 0x05, 0xe0, 0x81, 0x30, 0x60, 0xcc, 0x21, 0xa1, 0x06, 0x41, 0x01, 0xa0, 0x07, 0x90, 0x00
        ],
        [
            0x32, 0x00, 0x36, 0x08, 0xe0, 0x08, 0xc6, 0x00, 0x80, 0x21, 0x08, 0x01, 0xc8, 0x66, 0x00, 0x4e,
            0x32, 0x00, 0x62, 0x0f, 0x00, 0x0b, 0x86, 0x01, 0xc0, 0x30, 0xc8, 0x00, 0x78, 0x63, 0x00, 0xce,
            0x33, 0x00, 0xc3, 0x1e, 0x00, 0x0f, 0x04, 0x03, 0x60, 0x10, 0x78, 0x00, 0x3c, 0x41, 0x00, 0xce,
            0x31, 0x00, 0x83, 0x34, 0x00, 0x38, 0x0c, 0x06, 0x30, 0x10, 0x1c, 0x00, 0x26, 0xc0, 0x80, 0x86,
            0x60, 0x03, 0x01, 0xc2, 0x01, 0x88, 0x18, 0x08, 0x08, 0x1c, 0x09, 0xc0, 0x61, 0x80, 0x60, 0x06,
            0x60, 0x86, 0x00, 0x83, 0x07, 0x08, 0xff, 0xf0, 0x0f, 0xff, 0x08, 0x70, 0x40, 0x80, 0x31, 0x03,
            0x60, 0x8c, 0x01, 0x83, 0x02, 0x09, 0xcc, 0x00, 0x00, 0x11, 0x88, 0x20, 0xc0, 0xc0, 0x11, 0x03,
            0xe0, 0x88, 0x03, 0x81, 0x03, 0x0f, 0x0c, 0x00, 0x00, 0x10, 0xf8, 0x60, 0x81, 0x60, 0x09, 0x03,
            0xa0, 0x70, 0x0c, 0xc0, 0x01, 0x18, 0x0c, 0x00, 0x00, 0x10, 0x0c, 0x40, 0x03, 0x10, 0x06, 0x07,
            0x20, 0x60, 0x08, 0x40, 0x81, 0x38, 0x0c, 0x00, 0x00, 0x10, 0x0e, 0xc0, 0x02, 0x08, 0x07, 0x02,
            0x20, 0xe0, 0x10, 0x60, 0x80, 0xcc, 0x0c, 0x00, 0x00, 0x10, 0x13, 0x81, 0x02, 0x0c, 0x07, 0x06,
            0x20, 0xb0, 0x30, 0x20, 0xc0, 0x84, 0x0c, 0x00, 0x00, 0x10, 0x13, 0x81, 0x06, 0x06, 0x04, 0x86,
            0x23, 0x10, 0xc0, 0x10, 0x43, 0x86, 0x08, 0x00, 0x00, 0x08, 0x31, 0x82, 0x0c, 0x01, 0x08, 0x66,
            0x26, 0x10, 0x80, 0x10, 0x66, 0xc2, 0x10, 0x00, 0x00, 0x0c, 0x21, 0xc2, 0x08, 0x00, 0x88, 0x36,
            0x2c, 0x01, 0x00, 0x10, 0x2c, 0x43, 0x30, 0x00, 0x00, 0x06, 0x61, 0x66, 0x08, 0x00, 0xc0, 0x16,
            0x38, 0x0b, 0x00, 0x00, 0x38, 0x61, 0x60, 0x00, 0x00, 0x03, 0x43, 0x34, 0x08, 0x00, 0x70, 0x0e,
            0x30, 0x0e, 0x00, 0x08, 0x18, 0x21, 0xc0, 0x00, 0x00, 0x01, 0xc2, 0x0c, 0x00, 0x00, 0x30, 0x0e,
            0x30, 0x0f, 0x00, 0x08, 0x1c, 0x61, 0x60, 0x00, 0x00, 0x03, 0xc3, 0x0c, 0x08, 0x00, 0x70, 0x0e,
            0x28, 0x09, 0x00, 0x00, 0x36, 0x43, 0x30, 0x00, 0x00, 0x06, 0x43, 0x16, 0x08, 0x00, 0xc8, 0x1e,
            0x2c, 0x08, 0x80, 0x00, 0x23, 0xc2, 0x30, 0x00, 0x00, 0x0c, 0x61, 0x32, 0x0c, 0x00, 0x88, 0x32,
            0x26, 0x00, 0xc0, 0x10, 0x61, 0x86, 0x18, 0x00, 0x00, 0x08, 0x21, 0x63, 0x04, 0x01, 0x0c, 0x66,
            0x21, 0x10, 0x30, 0x30, 0x40, 0xc4, 0x0c, 0x00, 0x00, 0x10, 0x10, 0x81, 0x06, 0x06, 0x06, 0x86,
            0x20, 0xb0, 0x10, 0x20, 0xc0, 0xec, 0x0c, 0x00, 0x00, 0x10, 0x11, 0x80, 0x02, 0x0c, 0x03, 0x06,
            0x20, 0xe0, 0x08, 0x60, 0x81, 0x38, 0x0c, 0x00, 0x00, 0x10, 0x13, 0x80, 0x03, 0x08, 0x03, 0x02,
            0xa0, 0x60, 0x0c, 0x60, 0x81, 0x18, 0x0c, 0x00, 0x00, 0x10, 0x0e, 0xc0, 0x81, 0x10, 0x07, 0x02,
            0xe0, 0x70, 0x03, 0xc0, 0x03, 0x0f, 0x0c, 0x00, 0x00, 0x10, 0x78, 0x60, 0xc0, 0x60, 0x09, 0x03,
            0x60, 0xc8, 0x01, 0x81, 0x02, 0x03, 0x8c, 0x00, 0x00, 0x10, 0xc8, 0x60, 0x40, 0xc0, 0x10, 0x03,
            0x60, 0xcc, 0x00, 0x81, 0x07, 0x00, 0xff, 0xf0, 0x0f, 0xf7, 0x08, 0x60, 0x60, 0x80, 0x30, 0x83,
            0x60, 0x86, 0x00, 0xc3, 0x03, 0x80, 0x1f, 0xf8, 0x0f, 0xfe, 0x08, 0xe0, 0x61, 0x80, 0x60, 0x82,
            0x30, 0x01, 0x01, 0x32, 0x00, 0x38, 0x0c, 0x06, 0x30, 0x10, 0x0e, 0x00, 0x36, 0x40, 0x80, 0xc6,
            0x31, 0x00, 0x81, 0x16, 0x00, 0x1e, 0x0c, 0x03, 0x60, 0x10, 0x38, 0x00, 0x3c, 0x61, 0x00, 0x46,
            0x31, 0x00, 0xe3, 0x0e, 0x00, 0x03, 0x04, 0x01, 0xc0, 0x30, 0xf8, 0x00, 0xf8, 0x63, 0x00, 0x6e
        ],
        [
            0x40, 0x04, 0x1c, 0x00, 0x98, 0x02, 0x03, 0x00, 0x80, 0x20, 0x21, 0xdf, 0x80, 0x0c, 0x18, 0x01,
            0x40, 0x04, 0x30, 0x01, 0x0e, 0x02, 0x01, 0x00, 0x80, 0x40, 0x20, 0x36, 0x00, 0x07, 0x10, 0x01,
            0x20, 0x02, 0xc0, 0x01, 0x0d, 0x84, 0x01, 0x80, 0x80, 0xc0, 0x10, 0xcc, 0x40, 0x01, 0xa0, 0x02,
            0x20, 0x03, 0x00, 0x02, 0x04, 0xe4, 0x00, 0x80, 0x80, 0x80, 0x11, 0x88, 0x40, 0x00, 0x60, 0x02,
            0x10, 0x0f, 0x00, 0x06, 0x02, 0x38, 0x00, 0x40, 0x81, 0x00, 0x0e, 0x10, 0x20, 0x00, 0x70, 0x04,
            0x10, 0x19, 0x80, 0x04, 0x03, 0x1c, 0x00, 0x40, 0x81, 0x00, 0x0c, 0x30, 0x30, 0x00, 0xcc, 0x04,
            0x08, 0x60, 0xc0, 0x08, 0x01, 0x13, 0x00, 0x20, 0x82, 0x00, 0x64, 0x60, 0x18, 0x00, 0x83, 0x08,
            0x05, 0x80, 0x40, 0x18, 0x01, 0xa0, 0xc0, 0x10, 0x84, 0x01, 0x82, 0x40, 0x08, 0x01, 0x00, 0xd0,
            0x06, 0x00, 0x60, 0x10, 0x00, 0xa0, 0x70, 0x10, 0x84, 0x07, 0x03, 0x40, 0x0c, 0x03, 0x00, 0x30,
            0x1d, 0x00, 0x20, 0x20, 0x00, 0xc0, 0x18, 0x08, 0x88, 0x0c, 0x01, 0x80, 0x04, 0x02, 0x00, 0x7c,
            0x30, 0x80, 0x10, 0x20, 0x01, 0x80, 0x06, 0x0c, 0x98, 0x30, 0x00, 0xc0, 0x02, 0x04, 0x00, 0xc6,
            0xc0, 0x40, 0x10, 0x40, 0x03, 0x40, 0x03, 0x04, 0x90, 0x60, 0x00, 0xe0, 0x03, 0x04, 0x01, 0x01,
            0x00, 0x20, 0x08, 0xc0, 0x06, 0x40, 0x00, 0xc2, 0xb1, 0x80, 0x01, 0xb0, 0x01, 0x08, 0x02, 0x00,
            0x00, 0x18, 0x0c, 0x80, 0x18, 0x40, 0x00, 0x32, 0xa6, 0x00, 0x01, 0x0c, 0x00, 0x88, 0x0c, 0x00,
            0x00, 0x0e, 0x05, 0x00, 0x70, 0x40, 0x00, 0x1d, 0xcc, 0x00, 0x01, 0x03, 0x00, 0x90, 0x38, 0x00,
            0x00, 0x01, 0xc7, 0x01, 0x80, 0x40, 0x00, 0x07, 0xf0, 0x00, 0x01, 0x00, 0xc0, 0x51, 0xc0, 0x00,
            0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00,
            0x00, 0x03, 0x83, 0x01, 0x80, 0x40, 0x00, 0x03, 0xe0, 0x00, 0x01, 0x00, 0xe0, 0x60, 0x70, 0x00,
            0x00, 0x0c, 0x05, 0x00, 0x60, 0x40, 0x00, 0x0f, 0xf8, 0x00, 0x01, 0x03, 0x80, 0xd0, 0x1c, 0x00,
            0x00, 0x10, 0x05, 0x80, 0x18, 0x40, 0x00, 0x1b, 0xee, 0x00, 0x01, 0x06, 0x00, 0x90, 0x06, 0x00,
            0x00, 0x60, 0x08, 0x80, 0x04, 0x40, 0x00, 0x62, 0xa3, 0x00, 0x01, 0x18, 0x01, 0x08, 0x03, 0x00,
            0x80, 0xc0, 0x08, 0x40, 0x03, 0x80, 0x01, 0x86, 0x90, 0xc0, 0x01, 0x20, 0x01, 0x0c, 0x00, 0xc0,
            0x61, 0x80, 0x10, 0x60, 0x01, 0x80, 0x03, 0x04, 0x90, 0x20, 0x00, 0xc0, 0x02, 0x04, 0x00, 0x63,
            0x3a, 0x00, 0x30, 0x20, 0x00, 0xc0, 0x0c, 0x08, 0x88, 0x18, 0x00, 0x80, 0x06, 0x02, 0x00, 0x3e,
            0x0e, 0x00, 0x20, 0x30, 0x01, 0xe0, 0x38, 0x08, 0x8c, 0x0e, 0x01, 0x80, 0x04, 0x02, 0x00, 0x18,
            0x0f, 0x00, 0x40, 0x10, 0x01, 0x20, 0x60, 0x10, 0x84, 0x03, 0x03, 0xc0, 0x0c, 0x01, 0x00, 0x68,
            0x08, 0xc0, 0x40, 0x08, 0x03, 0x11, 0x80, 0x30, 0x86, 0x00, 0xc2, 0x40, 0x08, 0x01, 0x01, 0x84,
            0x10, 0x30, 0x80, 0x04, 0x02, 0x1e, 0x00, 0x20, 0x83, 0x00, 0x1c, 0x20, 0x10, 0x00, 0x86, 0x02,
            0x20, 0x1d, 0x00, 0x04, 0x04, 0x18, 0x00, 0x40, 0x81, 0x00, 0x0c, 0x20, 0x20, 0x00, 0x5c, 0x02,
            0x20, 0x07, 0x00, 0x02, 0x0c, 0x6c, 0x00, 0xc0, 0x81, 0x80, 0x0b, 0x10, 0x20, 0x00, 0x70, 0x01,
            0x40, 0x03, 0x80, 0x03, 0x08, 0xc4, 0x00, 0x80, 0x80, 0x80, 0x19, 0x98, 0x40, 0x00, 0xe0, 0x01,
            0x40, 0x06, 0x60, 0x01, 0x13, 0x04, 0x01, 0x80, 0x80, 0x40, 0x10, 0x68, 0x40, 0x03, 0xb0, 0x00
        ],
        [
            0x00, 0x60, 0x70, 0x01, 0x80, 0x03, 0xe0, 0x42, 0x43, 0x0e, 0x80, 0x00, 0xc0, 0x00, 0xec, 0x00,
            0x00, 0x21, 0xc0, 0x00, 0x80, 0x01, 0xb8, 0x43, 0xc3, 0x19, 0x80, 0x01, 0x80, 0x00, 0x3c, 0x00,
            0x00, 0x37, 0x00, 0x00, 0xc0, 0x01, 0x8e, 0x41, 0xc2, 0x71, 0x00, 0x01, 0x00, 0x00, 0x1c, 0x00,
            0x00, 0x1c, 0x00, 0x00, 0x60, 0x00, 0xc7, 0x41, 0x82, 0xc3, 0x00, 0x03, 0x00, 0x00, 0x1e, 0x00,
            0x00, 0x38, 0x00, 0x00, 0x30, 0x00, 0xc1, 0xc1, 0x83, 0x83, 0x00, 0x06, 0x00, 0x00, 0x31, 0x80,
            0x00, 0x78, 0x00, 0x00, 0x18, 0x00, 0x60, 0xe1, 0x87, 0x06, 0x00, 0x0c, 0x00, 0x00, 0x20, 0xc0,
            0x00, 0xcc, 0x00, 0x00, 0x18, 0x00, 0x20, 0x71, 0xce, 0x04, 0x00, 0x18, 0x00, 0x00, 0x60, 0x60,
            0x01, 0x86, 0x00, 0x00, 0x0c, 0x00, 0x30, 0x3b, 0xde, 0x0c, 0x00, 0x30, 0x00, 0x00, 0xc0, 0x30,
            0x03, 0x02, 0x00, 0x00, 0x07, 0x00, 0x18, 0x3f, 0x7e, 0x18, 0x20, 0x60, 0x00, 0x00, 0x80, 0x18,
            0x06, 0x03, 0x00, 0x00, 0x03, 0x9f, 0xfc, 0x37, 0x74, 0x3f, 0xff, 0xf0, 0x00, 0x01, 0x80, 0x0c,
            0x0c, 0x01, 0x80, 0x00, 0x03, 0xff, 0xff, 0xb3, 0x6f, 0xf8, 0x01, 0xfe, 0x00, 0x03, 0x00, 0x06,
            0x18, 0x00, 0xc0, 0x00, 0x3f, 0x60, 0x03, 0xf3, 0xef, 0xe0, 0x03, 0x03, 0xc0, 0x06, 0x00, 0x02,
            0x10, 0x00, 0x60, 0x00, 0xf0, 0x38, 0x03, 0x1f, 0xfc, 0xc0, 0x0e, 0x00, 0xf0, 0x0c, 0x00, 0x03,
            0x30, 0x00, 0x30, 0x03, 0x80, 0x0e, 0x01, 0xcf, 0xf9, 0x80, 0x38, 0x00, 0x1c, 0x18, 0x00, 0x01,
            0x60, 0x00, 0x18, 0x0e, 0x00, 0x07, 0x80, 0xff, 0xff, 0xc0, 0xe0, 0x00, 0x07, 0x30, 0x00, 0x00,
            0x40, 0x00, 0x0c, 0x38, 0x00, 0x01, 0xe7, 0xfe, 0x7f, 0xfb, 0x80, 0x00, 0x01, 0xe0, 0x00, 0x00,
            0xc0, 0x00, 0x06, 0x60, 0x00, 0x00, 0x3e, 0x1e, 0x3c, 0x1f, 0x00, 0x00, 0x01, 0xe0, 0x00, 0x00,
            0x80, 0x00, 0x03, 0xc0, 0x00, 0x00, 0xff, 0xfe, 0x3f, 0xfb, 0xc0, 0x00, 0x07, 0x70, 0x00, 0x01,
            0x80, 0x00, 0x03, 0xe0, 0x00, 0x03, 0xc0, 0xff, 0xff, 0x80, 0x70, 0x00, 0x0c, 0x18, 0x00, 0x01,
            0x80, 0x00, 0x06, 0x70, 0x00, 0x07, 0x00, 0xcf, 0xf9, 0xc0, 0x1c, 0x00, 0x38, 0x0c, 0x00, 0x03,
            0xc0, 0x00, 0x0c, 0x1e, 0x00, 0x1c, 0x01, 0x9f, 0xfc, 0xe0, 0x06, 0x01, 0xe0, 0x06, 0x00, 0x06,
            0x40, 0x00, 0x18, 0x07, 0x80, 0x30, 0x03, 0x3b, 0xef, 0xf0, 0x03, 0x8f, 0x80, 0x03, 0x00, 0x06,
            0x60, 0x00, 0x30, 0x00, 0xf8, 0xe0, 0x07, 0xf3, 0x67, 0xfc, 0x01, 0xfc, 0x00, 0x01, 0x80, 0x0c,
            0x30, 0x00, 0x60, 0x00, 0x1f, 0xe1, 0xff, 0x33, 0x76, 0x1f, 0xff, 0xe0, 0x00, 0x00, 0xc0, 0x18,
            0x18, 0x00, 0xc0, 0x00, 0x03, 0xff, 0xf8, 0x37, 0x7a, 0x0c, 0x00, 0x30, 0x00, 0x00, 0xc0, 0x30,
            0x0c, 0x00, 0x80, 0x00, 0x06, 0x00, 0x18, 0x2d, 0x6e, 0x06, 0x00, 0x18, 0x00, 0x00, 0x60, 0x60,
            0x06, 0x01, 0x80, 0x00, 0x0c, 0x00, 0x30, 0x39, 0x47, 0x02, 0x00, 0x0c, 0x00, 0x00, 0x30, 0xc0,
            0x03, 0x03, 0x00, 0x00, 0x18, 0x00, 0x20, 0x71, 0xc3, 0x03, 0x00, 0x06, 0x00, 0x00, 0x11, 0x80,
            0x01, 0x82, 0x00, 0x00, 0x10, 0x00, 0x60, 0x61, 0xc1, 0x81, 0x80, 0x03, 0x00, 0x00, 0x1f, 0x00,
            0x00, 0xc6, 0x00, 0x00, 0x30, 0x00, 0xc1, 0xe0, 0xc1, 0xe0, 0x80, 0x01, 0x00, 0x00, 0x0e, 0x00,
            0x00, 0x74, 0x00, 0x00, 0x60, 0x00, 0xc3, 0x60, 0xc1, 0x30, 0xc0, 0x01, 0x80, 0x00, 0x3c, 0x00,
            0x00, 0x1c, 0x00, 0x00, 0x40, 0x01, 0x8e, 0x41, 0xc1, 0x9c, 0x40, 0x00, 0xc0, 0x00, 0x74, 0x00
        ],
    ]

    active_triggers = [False, False]

    def __init__(self, pages: list):
        duration_options = list(range(0, 10000, 100))
        duration_options[0] = 10

        self.settings = [
            {
                'display': 'Begin at',
                'name': 'beginning',
                'options': [
                    'Start', 'End'
                ],
            },
            {
                'display': 'Delay (ms)',
                'name': 'delay',
                'options': list(range(0, 10000, 100)),
                'fine': list(range(0, 100 + 1, 10)),
            },
            {
                'display': 'Duration (ms)',
                'name': 'duration',
                'options': duration_options,
                'fine': list(range(0, 100 + 1, 10)),
            },
            {
                'display': 'Divisions',
                'name': 'divisions',
                'options': list(range(0, 100 + 1)),
            },
            {
                'display': 'Repetitions',
                'name': 'repetitions',
                'options': list(range(0, 100 + 1)),
            },
            {
                'display': 'Probability',
                'name': 'probability',
                'options': list(range(0, 100, 10)),
                'fine': list(range(0, 10 + 1)),
            },
            {
                'display': 'Proba / div',
                'name': 'division_probability',
                'options': list(range(0, 100, 10)),
                'fine': list(range(0, 10 + 1)),
            },
        ]

        self._pages_knob = LockableKnob(k1, 0)
        self._pages_knob.request_unlock()

        self._settings_knob = LockableKnob(k2, 0)
        self._settings_knob.request_unlock()

        self._pages = pages
        self._current_page = 0
        self._current_setting = None
        self._current_value = None
        self._current_state = ''
        self._previous_state = ''
        self._selected_setting = self.settings[0]
        self._selected_setting_last_check = ticks_ms()
        self._is_menu_opened = True
        self._quit_settings = False
        self._menu_last_action = ticks_ms()

    def open_menu(self):
        self._is_menu_opened = True
        self._menu_last_action = time.ticks_ms()

    def handle_button1(self):
        menu_state = self._is_menu_opened

        self.open_menu()

        if not menu_state:
            return

        # If no setting is being edited: Select highlighted setting
        if not self._current_setting:
            self._current_setting = self._settings_knob.choice(self.settings)
            return

        # If a setting is being edited: Cancel setting edit
        self._quit_settings = True

    def handle_button2(self):
        menu_state = self._is_menu_opened

        self.open_menu()

        if not menu_state:
            return

        # If no setting is being edited: Select highlighted setting
        if not self._current_setting:
            self._current_setting = self._settings_knob.choice(self.settings)
            return

        # If a setting is being edited: Save currently edited setting
        value = self._current_value

        if self._current_setting['name'] == 'beginning':
            value = KarmaOutput.BEGIN_AT_START if self._current_value == 'Start' else KarmaOutput.BEGIN_AT_END

        setattr(self._pages[self._current_page]['cv'], self._current_setting['name'], value)

        self._quit_settings = True

    def centred_text_line(self, text, y, colour=1):
        """Displays the given text horizontally centered on its line."""
        x_offset = int((oled.width - ((len(text) + 1) * 7)) / 2) - 1
        oled.text(text, x_offset, y, colour)

    def arrow(self, x, y, direction=None, size=4, colour=1):
        """Displays an arrow of the desired size and colour pointing left, right, top or bottom.
        Use the class constants DIRECTION_LEFT, DIRECTION_RIGHT, DIRECTION_TOP and DIRECTION_BOTTOM
        to set the direction."""
        direction = self.DIRECTION_LEFT if direction is None else direction

        if direction in [self.DIRECTION_LEFT, self.DIRECTION_RIGHT]:
            for i in range(size):
                xi = x + i if direction == self.DIRECTION_LEFT else oled.width - x - i - 1
                oled.line(xi, y - i, xi, y + i, colour)

            return

        for i in range(size):
            yi = y + i if direction == self.DIRECTION_TOP else oled.height - y - i - 1
            oled.line(x + i, yi, x - i, yi, colour)

    def _display_menu(self):
        current_page = self._pages[self._current_page]
        selected_setting = self._current_setting if self._current_setting else self._selected_setting

        oled.fill(0)

        # Show currently selected page
        oled.fill_rect(0, 1, oled.width, CHAR_HEIGHT + 1, 1)
        if self._current_page != 0:
            self.arrow(2, 5, self.DIRECTION_LEFT, colour=0)

        if self._current_page != len(self._pages) - 1:
            self.arrow(2, 5, self.DIRECTION_RIGHT, colour=0)

        self.centred_text_line(f'IN[{current_page["input"]}] OUT[{current_page["output"]}]', 2, 0)

        # Show currently hovered or selected setting
        if not self._current_setting:
            if self._selected_setting != self.settings[0]:
                self.arrow(2, 16, self.DIRECTION_LEFT)

            if self._selected_setting != self.settings[-1]:
                self.arrow(2, 16, self.DIRECTION_RIGHT)

        self.centred_text_line(f'{selected_setting["display"]}', 13)

        # Show setting value
        if self._current_value is not None:
            if self._current_value != selected_setting['options'][0]:
                self.arrow(2, 26, self.DIRECTION_LEFT)

            if self._current_value != selected_setting['options'][-1]:
                self.arrow(2, 26, self.DIRECTION_RIGHT)

            self.centred_text_line(f'{self._current_value}', 23)
        else:
            value = getattr(self._pages[self._current_page]['cv'], selected_setting['name'])

            if selected_setting['name'] == 'beginning':
                value = 'Start' if value == KarmaOutput.BEGIN_AT_START else 'End'

            self.centred_text_line(f'{value}', 23)

        oled.show()

    def main(self):
        if not self._is_menu_opened:
            return

        if ticks_diff(time.ticks_ms(), self._menu_last_action) >= self.MENU_DELAY:
            self._previous_state = 'wallpaper'
            self._is_menu_opened = False
            oled.fill(0)
            oled.blit(framebuf.FrameBuffer(bytearray(choice(self.SCREENSAVERS)), 128, 32, framebuf.MONO_HLSB), 0, 0)
            oled.show()
            return

        if self._quit_settings:
            self._quit_settings = False
            self._current_setting = None
            self._current_value = None

            # Unlock the page selection and setting knobs when not editing a setting anymore
            self._pages_knob.request_unlock()
            self._settings_knob.request_unlock()

        if self._current_setting is not None:
            # Lock the page selection knob during settings edit
            if self._pages_knob.state != LockableKnob.STATE_UNLOCKED:
                self._pages_knob.lock()

            # Lock the setting selection knob during settings edit
            if self._settings_knob.state != LockableKnob.STATE_UNLOCKED:
                self._settings_knob.lock()

            self._current_value = k2.choice(self._current_setting['options'])

            if 'fine' in self._current_setting:
                self._current_value += k1.choice(self._current_setting['fine'])
        elif ticks_diff(ticks_ms(), self._selected_setting_last_check) > self.SETTING_SELECTION_CHECK_DELAY:
            self._current_page = self._pages_knob.choice(list(range(0, len(self._pages))))
            self._selected_setting = self._settings_knob.choice(self.settings)
            self._selected_setting_last_check = ticks_ms()

        current_setting = self._current_setting["name"] if self._current_setting else self._selected_setting['name']
        self._current_state = f'{self._current_page},{current_setting},{self._current_value}'

        if self._current_state != self._previous_state:
            self.open_menu()
            self._display_menu()
            self._previous_state = self._current_state


class Karma(EuroPiScript):
    ANALOG_THRESHOLD = 0.9

    def __init__(self):
        super().__init__()

        self._ain_current_state = LOW
        self._ain_previous_state = LOW

        self._sections = [
            [KarmaOutput(cv1), KarmaOutput(cv4)],
            [KarmaOutput(cv3), KarmaOutput(cv6)],
        ]

        self._mixers = [
            {
                'cv': cv2,
                'mix': self._sections[0],
                'previous_mix': LOW,
                'type': 'or',
            },
            {
                'cv': cv5,
                'mix': self._sections[1],
                'previous_mix': LOW,
                'type': 'xor',
            },
        ]

        self._display = KarmaDisplay([
            {'cv': self._sections[0][0], 'output': '1', 'input': 1},
            {'cv': self._sections[0][1], 'output': '4', 'input': 1},
            {'cv': self._sections[1][0], 'output': '3', 'input': 2},
            {'cv': self._sections[1][1], 'output': '6', 'input': 2},
        ])

        @b1.handler_falling
        def b1_pressed():
            self._display.handle_button1()

        @b2.handler_falling
        def b2_pressed():
            self._display.handle_button2()

        @din.handler
        def din_started():
            self.start_section(0)

        @din.handler_falling
        def din_ended():
            self.end_section(0)

    def start_section(self, section: int):
        self._display.active_triggers[section] = True

        for cv in self._sections[section]:
            cv.start()

    def end_section(self, section: int):
        self._display.active_triggers[section] = False

        for cv in self._sections[section]:
            cv.end()

    def main(self):
        while True:
            # Emulate din.handler and din.handler_falling for ain so that it can be used as a din2
            self._ain_current_state = HIGH if ain.percent() > self.ANALOG_THRESHOLD else LOW

            if self._ain_current_state == HIGH and self._ain_previous_state == LOW:
                self.start_section(1)

            if self._ain_current_state == LOW and self._ain_previous_state == HIGH:
                self.end_section(1)

            self._ain_previous_state = self._ain_current_state

            # Let each output do their thing
            for section in self._sections:
                for cv in section:
                    cv.main()

            # Output the mix
            for mixer in self._mixers:
                if mixer['type'] == 'or':
                    mix = mixer['mix'][0].output or mixer['mix'][1].output
                else:
                    mix = mixer['mix'][0].output != mixer['mix'][1].output

                if mix != mixer['previous_mix']:
                    mixer['cv'].value(mix)
                    mixer['previous_mix'] = mix

            self._display.main()


if __name__ == '__main__':
    Karma().main()



